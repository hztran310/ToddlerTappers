<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Background Music</title>
    <script>
        let audioContext;
        let audioElement;
        let isMusicPlaying = false;

        // Function to initialize and start music
        function initMusic() {
            console.log("Initializing music...");
            if (!audioContext) {
                console.log("Creating new AudioContext...");
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("AudioContext created:", audioContext);

                // Create the audio element
                audioElement = new Audio('sound/background-music.mp3');  // Path to your music file
                audioElement.loop = true;
                audioElement.preload = 'auto';
                console.log("Audio element created:", audioElement);

                audioElement.oncanplaythrough = () => {
                    console.log("Audio element is ready to play.");
                };

                audioElement.onplaying = () => {
                    isMusicPlaying = true;
                    console.log("Music is playing...");
                    localStorage.setItem('backgroundMusicPlaying', 'true');
                };

                audioElement.onpause = () => {
                    isMusicPlaying = false;
                    console.log("Music is paused.");
                    localStorage.setItem('backgroundMusicPlaying', 'false');
                };

                audioElement.onended = () => {
                    isMusicPlaying = false;
                    console.log("Music ended.");
                    localStorage.setItem('backgroundMusicPlaying', 'false');
                };

                // Set music state based on saved state in localStorage
                const musicState = localStorage.getItem('backgroundMusicPlaying');
                console.log("Music state from localStorage:", musicState);

                if (musicState === 'true') {
                    console.log("Resuming music from localStorage...");
                    try {
                        audioElement.play().then(() => {
                            console.log("Music started automatically from localStorage.");
                        }).catch((error) => {
                            console.error("Error starting music from localStorage:", error);
                        });
                    } catch (error) {
                        console.error("Error starting music:", error);
                    }
                } else {
                    console.log("No music to resume. Music is paused.");
                    // Restart music if not resumed
                    audioElement.currentTime = 0; // Reset the audio to the beginning
                }
            } else {
                console.log("AudioContext already exists:", audioContext);
            }
        }

        // Function to handle user interaction to start music
        function startMusicOnClick() {
            console.log("User clicked, attempting to start music...");

            if (audioElement && !isMusicPlaying) {
                try {
                    // Check if the audio element is fully ready to play
                    if (audioElement.readyState >= 3) {  // READY_STATE_HAVE_FUTURE_DATA
                        console.log("Audio element is ready, attempting to play...");
                        audioElement.play().then(() => {
                            console.log("Music started successfully.");
                        }).catch((error) => {
                            console.error("Error starting music on click:", error);
                        });
                    } else {
                        console.log("Audio element not ready, unable to play.");
                    }
                } catch (error) {
                    console.error("Error starting music on click:", error);
                }
            } else {
                console.log("Music is already playing or no audio element to play.");
            }
        }

        // Wait for the DOM content to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Initializing music...");
            initMusic();  // Initialize music setup

            // Start music on any click to satisfy browser's autoplay policy
            document.body.addEventListener('click', startMusicOnClick);

            // Also, listen for the startMusic message from the iframe
            window.addEventListener('message', (event) => {
                if (event.origin !== window.location.origin) {
                    return; // Security check
                }

                if (event.data === 'startMusic') {
                    startMusicOnClick();
                }
            });
        });
    </script>
</head>
<body>
    <h2>Click anywhere on the page to start the music!</h2>
</body>
</html>
